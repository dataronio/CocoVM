<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Coco VM</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    </head>
    <body>

        <div id='computer'>
            <div id='program' style='float: left;'>
                <textarea id='prog' style='height: auto; 1px solid #eee;'>
;fibonacci sequence

;prints fib(42)
MOV @0, #42 

;init data
MOV %0, #1
MOV %1, #1
MOV %2, #0
MOV %3, #2
JMP main

main:
INC %3
MOV %2, %0
ADD %0, %1
MOV %1, %2
CMP %3, @0
JNEQ main
OUT %0
HLT
           </textarea></br>

                hexdump</br>
                <textarea id='binary'></textarea></br>

                <button onclick='assembleProg();'>Assemble</button>
                <button onclick='runProg();'>Run</button>
                <button onclick='stepProg();'>Step</button>
            </div>

            <div id='output' style='width: 100%; float: right;'>
                <textarea id='console'></textarea></br>
                <button onclick='document.getElementById("console").value = ``'>Clear</button>
            </div>

        </div>

        <script src="codemirror/lib/codemirror.js"></script>
        <script src='computer.js'></script>
        
        <script>
            var computer = new Computer({
                bits: 32,
                registerCount: 10,
                RAM_bytes: 128 
            });

            var prog_addr = 100;

            var editor = CodeMirror.fromTextArea(document.getElementById('prog'), {
                lineNumbers: true
            });

            function assembleProg() {
                let bin = computer.compile(editor.getValue());
                computer.loadProgram(bin, prog_addr);
                document.getElementById('binary').value = Utils.bits2hexstr(bin);
            }

            function stepProg() {
                computer.step();
            }

            function runProg() {
                computer.run(prog_addr, true);
            }

            computer.on('OUT', function(value) {

                value = computer.byte2num(value);

                document.getElementById('console').value += `${value}\n`;
                console.info(value);
            });

            computer.on('error', function(e) {
                console.warn(e);
                alert(e);
            });

        </script>

    </body>
</html>